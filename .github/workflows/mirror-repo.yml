name: Mirror to Codeberg

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Mirror to Codeberg
      run: |
        if ! git clone --bare https://RjBiermann:${{ secrets.GITHUB_TOKEN }}@github.com/RjBiermann/probable-octo-chainsaw.git; then
          echo "::error::Failed to clone source repository"
          exit 1
        fi

        cd probable-octo-chainsaw.git

        if ! git remote add mirror https://RjBiermann:${{ secrets.CODEBERG_TOKEN }}@codeberg.org/RjBiermann/probable-octo-chainsaw.git; then
          echo "::error::Failed to add mirror remote"
          exit 1
        fi

        if ! git push mirror --all --force; then
          echo "::error::Failed to push branches to mirror"
          exit 1
        fi

        if ! git push mirror --tags --force; then
          echo "::error::Failed to push tags to mirror"
          exit 1
        fi

        echo "Successfully mirrored to Codeberg"
