name: Build

# https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#concurrency
concurrency:
  group: "build"
  cancel-in-progress: false  # Queue builds to avoid losing version bumps

on:
  workflow_dispatch:  # Manual builds (no version bump)
  push:
    branches:
      - master
      - main

# Restrict default permissions — each job declares only what it needs
permissions: {}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4

      - name: Setup JDK 17
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Run Tests
        run: ./gradlew test --parallel --build-cache --no-daemon

      - name: Verify Compilation
        run: ./gradlew compileDebugKotlin --parallel --build-cache --no-daemon

      - name: Summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "## Validate: Passed :white_check_mark:" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Validate: Failed :x:" >> "$GITHUB_STEP_SUMMARY"
          fi

  bump:
    name: Bump Versions
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push version bump commits
    needs: [validate]
    outputs:
      bumped: ${{ steps.bump-versions.outputs.bumped }}
      bumped_plugins: ${{ steps.bump-versions.outputs.bumped_plugins }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Full history for accurate diff comparison

      - name: Check for skip in commit message
        id: skip-check
        run: |
          commit_msg=$(git log -1 --pretty=%B)
          if echo "$commit_msg" | grep -qi "\[skip-bump\]"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::notice::Skipping version bump due to [skip-bump] in commit message"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump plugin versions
        id: bump-versions
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          .github/scripts/bump-versions.sh \
            --before "${{ github.event.before }}" \
            --after "${{ github.event.after }}"

      - name: Summary
        if: steps.bump-versions.outputs.bumped == 'true'
        run: |
          {
            echo "## Version Bump"
            echo "Bumped plugins:${{ steps.bump-versions.outputs.bumped_plugins }}"
          } >> "$GITHUB_STEP_SUMMARY"

  build:
    name: Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push to builds branch
    needs: [validate, bump]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.bump.result == 'success' || needs.bump.result == 'skipped')
    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: "src"
          ref: ${{ github.ref }}  # Branch HEAD at checkout time; includes bump commit if pushed by prior job
          fetch-depth: 2  # Need parent commit for diff

      - name: Check for source changes
        id: changes
        working-directory: src
        run: |
          # Compare against parent commit to detect if plugin source changed
          # Fail-open: if diff fails (no parent, shallow clone), assume source changes
          diff_err=$(mktemp)
          changed_files=$(git diff --name-only HEAD~1 HEAD 2>"$diff_err") || {
            echo "::warning::Could not diff against parent commit, assuming source changes: $(cat "$diff_err")"
            rm -f "$diff_err"
            echo "has_source=true" >> "$GITHUB_OUTPUT"
            exit 0
          }
          rm -f "$diff_err"
          if echo "$changed_files" | grep -v '^$' | grep -qvE '^\.github/|\.md$|^LICENSE$'; then
            echo "has_source=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_source=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Skipping build — no plugin source changes detected"
          fi

      - name: Checkout builds
        if: steps.changes.outputs.has_source == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: "builds"
          path: "builds"

      - name: Clean old builds
        if: steps.changes.outputs.has_source == 'true'
        run: |
          shopt -s nullglob
          cs3_files=("$GITHUB_WORKSPACE"/builds/*.cs3)
          if [[ ${#cs3_files[@]} -gt 0 ]]; then
            rm "${cs3_files[@]}" || {
              echo "::error::Failed to remove old .cs3 files"
              exit 1
            }
            echo "Removed ${#cs3_files[@]} old .cs3 files"
          else
            echo "No old .cs3 files to clean"
          fi

      - name: Setup JDK 17
        if: steps.changes.outputs.has_source == 'true'
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        if: steps.changes.outputs.has_source == 'true'
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Build Plugins
        if: steps.changes.outputs.has_source == 'true'
        working-directory: src
        run: .github/scripts/build-plugins.sh "$GITHUB_WORKSPACE/builds"

      - name: Push builds
        if: steps.changes.outputs.has_source == 'true'
        run: src/.github/scripts/push-builds.sh "$GITHUB_WORKSPACE/builds" "$GITHUB_SHA"

      - name: Summary
        if: always()
        run: |
          if [[ "${{ steps.changes.outputs.has_source }}" != "true" ]]; then
            echo "## Build: Skipped (no source changes) :white_circle:" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ job.status }}" == "success" ]]; then
            {
              echo "## Build: Success :white_check_mark:"
              shopt -s nullglob
              cs3_files=("$GITHUB_WORKSPACE"/builds/*.cs3)
              echo "Deployed **${#cs3_files[@]}** plugins to builds branch"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Build: Failed :x:" >> "$GITHUB_STEP_SUMMARY"
          fi
