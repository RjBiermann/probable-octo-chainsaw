name: Build

# https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#concurrency
concurrency:
  group: "build"
  cancel-in-progress: false  # Queue builds to avoid losing version bumps

on:
  workflow_dispatch:  # Manual builds (no version bump)
  push:
    branches:
      - master
      - main

# Restrict default permissions â€” each job declares only what it needs
permissions: {}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Setup JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Run Tests
        run: ./gradlew test --parallel --build-cache --no-daemon

      - name: Verify Compilation
        run: ./gradlew compileDebugKotlin --parallel --build-cache --no-daemon

      - name: Summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "## Validate: Passed :white_check_mark:" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Validate: Failed :x:" >> "$GITHUB_STEP_SUMMARY"
          fi

  bump:
    name: Bump Versions
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push version bump commits
    needs: [validate]
    outputs:
      bumped: ${{ steps.bump-versions.outputs.bumped }}
      bumped_plugins: ${{ steps.bump-versions.outputs.bumped_plugins }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Full history for accurate diff comparison

      - name: Check for skip in commit message
        id: skip-check
        run: |
          commit_msg=$(git log -1 --pretty=%B)
          if echo "$commit_msg" | grep -qi "\[skip-bump\]"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::notice::Skipping version bump due to [skip-bump] in commit message"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump plugin versions
        id: bump-versions
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          .github/scripts/bump-versions.sh \
            --before "${{ github.event.before }}" \
            --after "${{ github.event.after }}"

      - name: Summary
        if: steps.bump-versions.outputs.bumped == 'true'
        run: |
          {
            echo "## Version Bump"
            echo "Bumped plugins:${{ steps.bump-versions.outputs.bumped_plugins }}"
          } >> "$GITHUB_STEP_SUMMARY"

  build:
    name: Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push to builds branch
    needs: [validate, bump]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.bump.result == 'success' || needs.bump.result == 'skipped')
    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: "src"
          ref: ${{ github.ref }}  # Branch HEAD, includes bump commit if pushed

      - name: Checkout builds
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: "builds"
          path: "builds"

      - name: Clean old builds
        run: |
          shopt -s nullglob
          cs3_files=("$GITHUB_WORKSPACE"/builds/*.cs3)
          if [[ ${#cs3_files[@]} -gt 0 ]]; then
            rm "${cs3_files[@]}" || {
              echo "::error::Failed to remove old .cs3 files"
              exit 1
            }
            echo "Removed ${#cs3_files[@]} old .cs3 files"
          else
            echo "No old .cs3 files to clean"
          fi

      - name: Setup JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Build Plugins
        working-directory: src
        run: .github/scripts/build-plugins.sh "$GITHUB_WORKSPACE/builds"

      - name: Push builds
        run: src/.github/scripts/push-builds.sh "$GITHUB_WORKSPACE/builds" "$GITHUB_SHA"

      - name: Summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            {
              echo "## Build: Success :white_check_mark:"
              shopt -s nullglob
              cs3_files=("$GITHUB_WORKSPACE"/builds/*.cs3)
              echo "Deployed **${#cs3_files[@]}** plugins to builds branch"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Build: Failed :x:" >> "$GITHUB_STEP_SUMMARY"
          fi
