name: PR Check

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Setup JDK 17
        uses: actions/setup-java@v4.7.1
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      - name: Validate Compilation
        run: |
          chmod +x gradlew

          # Compile all Kotlin code
          if ! ./gradlew compileDebugKotlin --parallel --build-cache --no-daemon; then
            echo "::error::Compilation failed"
            exit 1
          fi
          echo "Compilation successful"

      - name: Run Tests
        run: |
          # Run all tests
          if ! ./gradlew test --parallel --build-cache --no-daemon; then
            echo "::error::Tests failed"
            exit 1
          fi
          echo "All tests passed"

      - name: Verify Plugin Builds
        run: |
          # Build all plugins to verify they produce valid .cs3 files
          if ! ./gradlew make --parallel --build-cache --no-daemon; then
            echo "::error::Plugin build failed"
            exit 1
          fi

          # Verify .cs3 files were produced
          shopt -s nullglob globstar
          cs3_files=(**/build/*.cs3)
          if [[ ${#cs3_files[@]} -eq 0 ]]; then
            echo "::error::No .cs3 files were produced by the build"
            exit 1
          fi
          echo "Successfully built ${#cs3_files[@]} plugins"
