name: PR Check

on:
  pull_request:
    branches:
      - master
      - main

permissions: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4

      - name: Setup JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: "adopt"
          java-version: 17
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Validate Compilation
        run: ./gradlew compileDebugKotlin --parallel --build-cache --no-daemon

      - name: Run Tests
        run: ./gradlew test --parallel --build-cache --no-daemon

      - name: Verify Plugin Builds
        run: |
          ./gradlew make --parallel --build-cache --no-daemon

          shopt -s nullglob globstar
          cs3_files=(**/build/*.cs3)
          if [[ ${#cs3_files[@]} -eq 0 ]]; then
            echo "::error::No .cs3 files were produced by the build"
            exit 1
          fi
          echo "Successfully built ${#cs3_files[@]} plugins"
